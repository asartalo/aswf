<?php

namespace Asar\Http\Resource;

use \Asar\Http\Message\Request;
use \Asar\Http\Message\Response;
use \Asar\Http\RequestHandlerInterface;
use \Asar\Utilities\String;

class ResourceDispatcher implements RequestHandlerInterface {

  private $resource;

  private $knownMethods = array(
    'GET'    => 'Asar\Http\Resource\GetInterface',
    'POST'   => 'Asar\Http\Resource\PostInterface',
    'PUT'    => 'Asar\Http\Resource\PutInterface',
    'DELETE' => 'Asar\Http\Resource\DeleteInterface',
  );

  private $specialMethods = array(
    'HEAD' => 'invokeHeadRequest'
  );

  function __construct($resource = null) {
    $this->resource = $resource;
  }

  function handleRequest(Request $request) {
    if ($this->resource) {
      return $this->callResourceMethod($request);
    }
    $response = new Response;
    $response->setStatus(404);
    return $response;
  }

  protected function callResourceMethod($request) {
    $method = $request->getMethod();
    if (
      isset($this->knownMethods[$method])
      && $this->resource instanceof $this->knownMethods[$method]
    ) {
      return $this->resource->$method($request);
    }
    if (isset($this->specialMethods[$method])) {
      return call_user_func(array($this, $this->specialMethods[$method]), $request);
    }
    return new Response(array('status' => 405));
  }

  protected function callGetMethod(GetInterface $resource, $request) {
    return $resource->GET($request);
  }

  protected function callPostMethod(PostInterface $resource, $request) {
    return $resource->POST($request);
  }

  protected function callPutMethod(PutInterface $resource, $request) {
    return $resource->PUT($request);
  }

  protected function callDeleteMethod(DeleteInterface $resource, $request) {
    return $resource->DELETE($request);
  }

  protected function invokeHeadRequest($request) {
    return $this->resource->GET($request);
  }

}
